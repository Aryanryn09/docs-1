"use strict";(self.webpackChunkbook=self.webpackChunkbook||[]).push([[6906],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),d=o,k=u["".concat(l,".").concat(d)]||u[d]||m[d]||r;return n?a.createElement(k,i(i({ref:t},c),{},{components:n})):a.createElement(k,i({ref:t},c))}));function k(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:o,i[1]=s;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7420:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(7462),o=(n(7294),n(3905));const r={sidebar_position:3},i="3.3 Docker + Wasm",s={unversionedId:"build-and-run/docker_wasm",id:"build-and-run/docker_wasm",title:"3.3 Docker + Wasm",description:"Docker announced its support for WebAssembly in the partnership with WasmEdge. So for WasmEdge developers, you could use Docker Desktop and Docker CLI to build, share and run WasmEdge apps.",source:"@site/docs/build-and-run/docker_wasm.md",sourceDirName:"build-and-run",slug:"/build-and-run/docker_wasm",permalink:"/book/docs/build-and-run/docker_wasm",draft:!1,editUrl:"https://github.com/alabulei1/book/docs/build-and-run/docker_wasm.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"3.2 The AoT Compiler",permalink:"/book/docs/build-and-run/aot"},next:{title:"Develop Wasm Apps in Rust",permalink:"/book/docs/category/develop-wasm-apps-in-rust"}},l={},p=[{value:"Configure the toolchains",id:"configure-the-toolchains",level:2},{value:"Run the Wasm app image",id:"run-the-wasm-app-image",level:2},{value:"Build a Wasm app image",id:"build-a-wasm-app-image",level:2},{value:"Run a multi-service application with Wasm",id:"run-a-multi-service-application-with-wasm",level:2}],c={toc:p};function u(e){let{components:t,...r}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"33-docker--wasm"},"3.3 Docker + Wasm"),(0,o.kt)("p",null,"Docker announced its support for WebAssembly in the partnership with WasmEdge. So for WasmEdge developers, you could use Docker Desktop and Docker CLI to build, share and run WasmEdge apps."),(0,o.kt)("h2",{id:"configure-the-toolchains"},"Configure the toolchains"),(0,o.kt)("p",null,"The easist way to use docker's WasmEdge integration is to download ",(0,o.kt)("a",{parentName:"p",href:"https://docs.docker.com/desktop/release-notes/"},"the newest Docker Desktop"),". "),(0,o.kt)("p",null,"Before you start, make sure you have turned on the containerd image store feature in your Docker Desktop. "),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/AH0ITnc.png",alt:null})),(0,o.kt)("h2",{id:"run-the-wasm-app-image"},"Run the Wasm app image"),(0,o.kt)("p",null,"Then, use ",(0,o.kt)("inlineCode",{parentName:"p"},"docker run"),"  to run the packaged Wasm image."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"docker run -dp 8080:8080 \\\n  --name=wasm-example \\\n  --runtime=io.containerd.wasmedge.v1 \\\n  --platform=wasi/wasm32 \\\n  michaelirwin244/wasm-example\n")),(0,o.kt)("p",null,"Here, we noticed  two new flags."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"--runtime=io.containerd.wasmedge.v1")," \u2013 This informs the Docker engine that we want to use the Wasm containerd shim instead of the standard Linux container runtime."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"--platform=wasi/wasm32")," \u2013 This specifies the architecture of the wasi/wasm32 image we want to use. By leveraging a Wasm architecture, you don\u2019t need to build separate images for the different machine architectures. The WasmEdge takes care of the final step of converting the Wasm binary to machine instructions.")),(0,o.kt)("p",null,"Next, open http://localhost:8080 in your browser or use ",(0,o.kt)("inlineCode",{parentName:"p"},"curl localhost:8080"),". The server will respond the following messages."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Hello world from Rust running with Wasm! Send POST data to /echo to have it echoed back to you%   \n")),(0,o.kt)("p",null,"That's all. Using Docker Desktop, it is easy to run a WasmEdge app."),(0,o.kt)("h2",{id:"build-a-wasm-app-image"},"Build a Wasm app image"),(0,o.kt)("p",null,"Now, we have known how to use Docker Desktop to run a Wasm image. Let's go back to dive into how to build a wasm app image."),(0,o.kt)("p",null,"Let's say you already have a compiled wasm file. To build a docker image, we also need to set up the ",(0,o.kt)("inlineCode",{parentName:"p"},"Dockerfile")," like the following content."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'FROM scratch\nENTRYPOINT [ "hello_world.wasm" ]\nCOPY ./target/wasm32-wasi/release/hello-world.wasm /hello-world.wasm\n')),(0,o.kt)("p",null,"After that, use ",(0,o.kt)("inlineCode",{parentName:"p"},"docker buildx")," to build a wasm app image."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"docker buildx build --platform wasi/wasm32 -t docker-wasm:0.1 .\n")),(0,o.kt)("p",null,"Use ",(0,o.kt)("inlineCode",{parentName:"p"},"docker push")," to publish the docker image."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"docker image push dockerid/docker-wasm:0.1\n")),(0,o.kt)("p",null,"After that, you could follow the Run the Wasm app image guide to run your Wasm image."),(0,o.kt)("h2",{id:"run-a-multi-service-application-with-wasm"},"Run a multi-service application with Wasm"),(0,o.kt)("p",null,"How about when we need to run an applications including multuple containers? ",(0,o.kt)("inlineCode",{parentName:"p"},"docker compose up")," could run serveral contaienrs at one time."),(0,o.kt)("p",null,"Let's take the microservice-rust-mysql as an example. It includes three containers. Two are Linux containers and one is Wasm container. In this case, we use ",(0,o.kt)("inlineCode",{parentName:"p"},"docker compose up")," to run three containers at once. Make sure your Docker Desktop is running and your repo includes a ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," file."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"For the instruction on setting up ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," file, please check out this article.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"// git clone the template project\n\n$ git clone https://github.com/second-state/microservice-rust-mysql.git\n\n// Use `docker compose` to run the example\n\n$ docker compose up\n")),(0,o.kt)("p",null,"Then, go back to Docker Desktop Dash board, you will see there're three containers running."),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(9524).Z,width:"2878",height:"1652"})),(0,o.kt)("p",null,"In this section, we learned how to run the Wasm app image and build the Wasm app image with the help of Docker Desktop. If you don't want to use Docker CLI, please check out this arctivle to build the Docker Engine with support of WasmEdge from Scratch."))}u.isMDXComponent=!0},9524:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/docker-3e1280f76a18879229e5625c11c7b7b7.jpeg"}}]);